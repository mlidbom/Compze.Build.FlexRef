<Project>

  <!--
    SwitchableReferences.props — Shared MSBuild infrastructure for switching
    between ProjectReference and PackageReference based on solution context.

    Import this file in your Directory.Build.props BEFORE declaring any
    per-dependency flag derivation properties.

    See SwitchableReferences.README.md for full usage instructions.
  -->

  <!--
    Step 1: Read the .slnx file and extract project filenames.

    Reads the solution XML, then uses Regex.Replace to wrap each
    Project/@Path filename in | delimiters:

        <Project Path="src/Acme.Core/Acme.Core.csproj" />
                   becomes
        <Project |Acme.Core.csproj| />

    The surrounding XML is kept but harmless — | never appears in
    normal XML content, so .Contains('|Acme.Core.csproj|') is an
    exact match against real project filenames.

    This is skipped entirely when:
    - NCrunch is running (NCrunch uses Custom Build Properties instead)
    - No solution context exists (e.g. bare `dotnet build MyProject.csproj`)
    - The solution file doesn't exist at the expected path

    $(_SwitchRef_SolutionProjects) is the public API for consumers.
  -->
  <PropertyGroup Condition="'$(NCrunch)' != '1'
                         And '$(SolutionPath)' != ''
                         And '$(SolutionPath)' != '*Undefined*'
                         And Exists('$(SolutionPath)')">
    <!--
      .slnx files list projects as XML like this:
          <Project Path="src/Acme.Core/Acme.Core.csproj" />

      The regex matches each Path="..." attribute, captures the filename
      after the last /, and replaces the whole match with |filename|:

          Path="src/Acme.Core/Acme.Core.csproj"  →  |Acme.Core.csproj|

      %28 and %29 are MSBuild escapes for ( and ) which MSBuild would
      otherwise interpret as its own syntax.

      The regex in normal notation:  Path="(?:[^"]*/)?([^"/]+)"
    -->
    <_SwitchRef_SolutionProjects>$([System.Text.RegularExpressions.Regex]::Replace(
        $([System.IO.File]::ReadAllText('$(SolutionPath)')),
        'Path="%28?:[^"]*/%29?%28[^"/]+%29"',
        '|$1|'))</_SwitchRef_SolutionProjects>
  </PropertyGroup>

  <!--
    Step 2: Per-dependency flag derivation.

    After importing this file, declare properties in your Directory.Build.props
    for each switchable dependency using this two-line pattern:

    <PropertyGroup>
      <_UsePackage_LibA Condition="'$(UsePackageReference_MyProj_LibA)' == 'true'">true</_UsePackage_LibA>
      <_UsePackage_LibA Condition="'$(_UsePackage_LibA)' != 'true'
                                 And '$(_SwitchRef_SolutionProjects)' != ''
                                 And !$(_SwitchRef_SolutionProjects.Contains('|LibA.csproj|'))">true</_UsePackage_LibA>
    </PropertyGroup>

    Line 1: Honours any explicit override (NCrunch Custom Build Properties / env var).
    Line 2: Checks the parsed project list — uses PackageReference only if we
             have solution context AND the project is NOT listed in it.
             The | delimiters ensure exact filename matching (no false positives
             from similarly-named projects like Company.LibA.csproj).

    If neither condition is met, the property stays empty/unset, which means
    the .csproj defaulting to ProjectReference (the safe default).
  -->

</Project>
